<!doctype html>









































<html
  class="not-ready lg:text-base"
  style="--bg: #fbfbfb"
  lang="en-us"
  dir="ltr"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>Analysis of ChineseAPT: RedDelta&#39;s Recent Infection Chain - TheAbsnt</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="The introduction
In this blog, we&rsquo;ll explore a recent infection chain of malware campaign carried out by Chinese State Sponsored threat actor RedDelta to deliver customized PlugX malware.
The infection chain we gonna cover was observed in later half of 2024, which consist of MSC(Microsoft Management Console Snap-In Control) file as the first-stage component. Upon execution, the MSC file was configured to execute VBScript that download and installs a remotely hosted Windows Installer (MSI) file, this MSI file then drops a legitimate executable vulnerable to DLL search order hijacking, a malicious loader DLL written in NIM programming language, and a DAT file containg encrypted PlugX payload and displays a decoy document." />
  <meta name="author" content="THEABSNT" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://theabsnt.github.io/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="https://theabsnt.github.io/theme.svg" />

  
  
  
  
  <link rel="preload" as="image" href="https://images.unsplash.com/photo-1568430462989-44163eb1752f?w=500&amp;auto=format&amp;fit=crop&amp;q=60&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwcm9maWxlLXBhZ2V8OXx8fGVufDB8fHx8fA%3D%3D" />
  
  

  
  
  <link rel="preload" as="image" href="https://theabsnt.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://theabsnt.github.io/github.svg" />
  
  <link rel="preload" as="image" href="https://theabsnt.github.io/rss.svg" />
  
  

  
  
  <script
    defer
    src="https://theabsnt.github.io/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link
    rel="icon"
    href="https://theabsnt.github.io/favicon.png"
  />
  <link
    rel="apple-touch-icon"
    href="https://theabsnt.github.io/favicon.png"
  />

  
  <meta name="generator" content="Hugo 0.144.0">

  
  
  
  
  
  
  <meta itemprop="name" content="Analysis of ChineseAPT: RedDelta&#39;s Recent Infection Chain">
  <meta itemprop="description" content="The introduction In this blog, we’ll explore a recent infection chain of malware campaign carried out by Chinese State Sponsored threat actor RedDelta to deliver customized PlugX malware.
The infection chain we gonna cover was observed in later half of 2024, which consist of MSC(Microsoft Management Console Snap-In Control) file as the first-stage component. Upon execution, the MSC file was configured to execute VBScript that download and installs a remotely hosted Windows Installer (MSI) file, this MSI file then drops a legitimate executable vulnerable to DLL search order hijacking, a malicious loader DLL written in NIM programming language, and a DAT file containg encrypted PlugX payload and displays a decoy document.">
  <meta itemprop="datePublished" content="2025-02-18T17:32:36+05:30">
  <meta itemprop="dateModified" content="2025-02-18T17:32:36+05:30">
  <meta itemprop="wordCount" content="1711">
  <meta itemprop="keywords" content="Reverse Engineering,Reddelta,Malware Analysis,Plugx,Malware Campaign">
  
  <meta property="og:url" content="https://theabsnt.github.io/posts/reddelta-plugx/reddelta-malware-campaign-aug-2024/">
  <meta property="og:site_name" content="TheAbsnt">
  <meta property="og:title" content="Analysis of ChineseAPT: RedDelta&#39;s Recent Infection Chain">
  <meta property="og:description" content="The introduction In this blog, we’ll explore a recent infection chain of malware campaign carried out by Chinese State Sponsored threat actor RedDelta to deliver customized PlugX malware.
The infection chain we gonna cover was observed in later half of 2024, which consist of MSC(Microsoft Management Console Snap-In Control) file as the first-stage component. Upon execution, the MSC file was configured to execute VBScript that download and installs a remotely hosted Windows Installer (MSI) file, this MSI file then drops a legitimate executable vulnerable to DLL search order hijacking, a malicious loader DLL written in NIM programming language, and a DAT file containg encrypted PlugX payload and displays a decoy document.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-02-18T17:32:36+05:30">
    <meta property="article:modified_time" content="2025-02-18T17:32:36+05:30">
    <meta property="article:tag" content="Reverse Engineering">
    <meta property="article:tag" content="Reddelta">
    <meta property="article:tag" content="Malware Analysis">
    <meta property="article:tag" content="Plugx">
    <meta property="article:tag" content="Malware Campaign">

  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Analysis of ChineseAPT: RedDelta&#39;s Recent Infection Chain">
  <meta name="twitter:description" content="The introduction In this blog, we’ll explore a recent infection chain of malware campaign carried out by Chinese State Sponsored threat actor RedDelta to deliver customized PlugX malware.
The infection chain we gonna cover was observed in later half of 2024, which consist of MSC(Microsoft Management Console Snap-In Control) file as the first-stage component. Upon execution, the MSC file was configured to execute VBScript that download and installs a remotely hosted Windows Installer (MSI) file, this MSI file then drops a legitimate executable vulnerable to DLL search order hijacking, a malicious loader DLL written in NIM programming language, and a DAT file containg encrypted PlugX payload and displays a decoy document.">

  
  

  
  <link rel="canonical" href="https://theabsnt.github.io/posts/reddelta-plugx/reddelta-malware-campaign-aug-2024/" />
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-[--w] px-8 lg:justify-center">
  <div class="relative z-50 ltr:mr-auto rtl:ml-auto flex items-center">
    <a class="-translate-y-[1px] text-2xl font-medium" href="https://theabsnt.github.io/"
      >TheAbsnt</a
    >
    <div
      class="btn-dark text-[0] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 ltr:-mr-8 rtl:-ml-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#fbfbfb'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse">
      
      <a
        class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal"
        href="/about/"
        >About</a
      >
      
    </nav>
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 rtl:space-x-reverse dark:invert ltr:lg:ml-14 rtl:lg:mr-14 lg:mt-0 lg:items-center"
    >
      
      <a
        class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./twitter.svg)"
        href="https://twitter.com/TheAbsnt"
        target="_blank"
        rel="me"
      >
        twitter
      </a>
      
      <a
        class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/TheAbsnt"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
      <a
        class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./rss.svg)"
        href="https://theabsnt.github.io/index.xml"
        target="_blank"
        rel="alternate"
      >
        rss
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-[--w] px-8 pb-16 pt-14 dark:prose-invert"
    >
      

<article>
  <header class="mb-14">
    <h1 class="!my-0 pb-2.5">Analysis of ChineseAPT: RedDelta&#39;s Recent Infection Chain</h1>

    
    <div class="text-xs antialiased opacity-60">
      
      <time>Feb 18, 2025</time>
      
      
      
      
      <span class="mx-1">&middot;</span>
      <span>THEABSNT</span>
      
    </div>
    
  </header>

  <section><h1 id="the-introduction">The introduction</h1>
<p>In this blog, we&rsquo;ll explore a recent infection chain of malware campaign carried out by Chinese State Sponsored threat actor RedDelta to deliver customized PlugX malware.</p>
<p>The infection chain we gonna cover was observed in later half of 2024, which consist of MSC(Microsoft Management Console Snap-In Control) file as the first-stage component. Upon execution, the MSC file was configured to execute VBScript that download and installs a remotely hosted Windows Installer (MSI) file, this MSI file then drops a legitimate executable vulnerable to DLL search order hijacking, a malicious loader DLL written in NIM programming language, and a DAT file containg encrypted PlugX payload and displays a decoy document.</p>
<p>This specific infection chain was observed when RedDelta targeted Mongolian Ministry of Defense and other Southeast Asia around August 2024 as per analysis done by Insikt Group from <a href="https://x.com/RecordedFuture">Recorded Future</a> in the pdf report from article <a href="https://www.recordedfuture.com/research/reddelta-chinese-state-sponsored-group-targets-mongolia-taiwan-southeast-asia">Chinese State-Sponsored RedDelta Targeted Taiwan, Mongolia, and Southeast Asia with Adapted PlugX Infection Chain</a></p>
<blockquote>
<p>Shout out to <a href="https://twitter.com/themalwareguy">themalwareguy</a> and <a href="https://www.0ffset.net/training/zero2auto/">Zero2Automated</a> for asking us to analyse this malware campaign as part of bi-monthly challenge for January 2025 :)</p></blockquote>
<h1 id="the-infection-chain">The infection chain</h1>
<p><img src="/mat-redDelta-plugx/infection-chain.png" alt="infection-chain"></p>
<hr>
<h1 id="technical-analysis">Technical analysis</h1>
<p>We&rsquo;ll go through the infection chain stage by stage and observe the TTTPs used, the samples can be found here <a href="https://github.com/StrikeReady-Inc/samples/tree/main/2024-08-01%20Meeting%20invitation">Strike Ready Labs</a>.</p>
<p>We&rsquo;ll kick-off with the .MSC file</p>
<h1 id="a-hoax--msc-file">A hoax : MSC file</h1>
<p>The infection chain starts with a file named <code>Meeting invitaion.msc</code> presenting itself as a PDF.
<img src="/mat-redDelta-plugx/msc-file-disguised-as-pdf.png" alt="msc-file-disguised-as-apdf">
This file performs a <a href="https://www.elastic.co/security-labs/grimresource">GrimeResource technique</a> which allows attackers to execute arbitrary code in Microsoft Management Console(<code>mmc.exe</code>)</p>
<p><img src="/mat-redDelta-plugx/msc-file-apds-xss-to-jscript.png" alt="msc-file-apds-xss-to-jscript">
<strong>tldr;</strong> this GrimeResource technique abuses an old XSS flaw found in <code>APDS.DLL</code> to runs <code>JScript</code> which uses <code>transformNode</code> obfuscation(aids in evading ActiveX security warnings) which leads to an unescaped XML script that executes an embedded <code>VBScript</code> in context of <code>mmc.exe</code>.</p>
<p><img src="/mat-redDelta-plugx/msc-file-unescaped-vbscript.png" alt="msc-file-unescaped-vbscript">
The <code>VBScript</code> instantiates an <code>WindowsInstaller.Installer</code> object where <code>wshshell.uilevel</code> is set <code>2</code> to perform silent installation (see <a href="https://learn.microsoft.com/en-us/windows/win32/msi/installer-uilevel">Installer.UILevel Property</a>), and downloads then installs a file <code>ver.dat</code> hosted on Microsoft Azure cloud with the subdomain <code>hxxps[:]//cdn7s65[.]z13[.]web[.]core[.]windows[.]net</code></p>
<p><strong>In short</strong>, when the users clicks the MSC file, the file runs the <code>VBScript</code> that downloads and install a remotely hosted MSI file ie. <code>ver.dat</code>.</p>
<hr>
<h1 id="the-reliance--msi-file">The reliance : MSI file</h1>
<p>The <a href="https://github.com/horsicq/Detect-It-Easy">DIE</a> output confirms that <code>ver.dat</code> is indeed an MSI Installer file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>cmd&gt; diec.exe files\ver.dat
</span></span><span style="display:flex;"><span>Binary
</span></span><span style="display:flex;"><span>    Installer: Microsoft Installer(MSI)
</span></span><span style="display:flex;"><span>    Data: Microsoft Compound
</span></span></code></pre></div><h2 id="dropped-files">Dropped files</h2>
<p>when examining suspicious MSI, we should start by looking at embedded files, we can use tools like as <a href="https://github.com/activescott/lessmsi">lessmsi</a> , <a href="https://github.com/mgeeky/msidump">msidump</a>, <a href="https://learn.microsoft.com/en-us/windows/win32/msi/orca-exe">orca</a> etc. to extract and view&rsquo;em:
<img src="/mat-redDelta-plugx/msi-file-table.png" alt="msi-file-table">
<img src="/mat-redDelta-plugx/msi-file-summary.png" alt="msi-file-summary"></p>
<p>also the summary section shows the creation date of August 2024 which matches campaign timelines</p>
<blockquote>
<p>NOTE: that Creation Date/Time can be spoofed or altered. But doesn&rsquo;t look like it&rsquo;s been spoofed this time</p></blockquote>
<p>With a quick triage on the files extracted, we see:</p>
<ul>
<li><code>LDevice.dat</code> : is a file with mostly gibberish bytes, hinting possibly packed/encrypted</li>
<li><code>hid.dll</code> : a <code>PE32</code> DLL file written with NIM programming language</li>
<li><code>LDeviceDectectionHelper.exe</code> : a legitimate and digitally signed executable by Logitech and also <a href="https://www.virustotal.com/gui/file/282fc12e4f36b6e2558f5dd33320385f41e72d3a90d0d3777a31ef1ba40722d6">Virus Total</a> shows it as clean file
<img src="/mat-redDelta-plugx/legitimate-file-details.png" alt="legitimate-file-details"></li>
</ul>
<h2 id="table-inspection">Table inspection</h2>
<p>MSI files are structured as relational databases used by the Windows Installer. The database consists of several tables, each serving a specific purpose in the installation process.</p>
<p>From malware analysis perspective - we gonna examine some of interesting inner tables. We can start by looking all actions that may happen automatically when installer runs.</p>
<blockquote>
<p>For in-depth analysis of MSI file check the footnote <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p></blockquote>
<h3 id="custom-action-table">Custom Action Table</h3>
<p><a href="https://learn.microsoft.com/en-us/windows/win32/msi/customaction-table">CustomAction Table</a> defines <a href="https://learn.microsoft.com/en-us/windows/win32/msi/custom-actions">custom actions</a> that refers user-defined command or script that runs during installation process that are usually not handled by MSI <a href="https://learn.microsoft.com/en-us/windows/win32/msi/standard-actions">Standard Actions</a>.
These actions can include running an executable, system command, loading a DLL, setting properties etc. Let&rsquo;s see what custom actions does this MSI file defines
<img src="/mat-redDelta-plugx/msi-custom-action-table.png" alt="msi-custom-action-table"></p>
<ul>
<li>the first action, <code>SetOblsaYFUJOqn</code> will set the property <code>OblsaYFUJOqn</code> to <code>[%LOCALAPPDATA]\FRKBrMZCk</code> (see <a href="https://learn.microsoft.com/en-us/windows/win32/msi/custom-action-type-51">Custom Action Type 51</a>), indicating the installation directory for the files to be extracted</li>
<li>the second action, <code>WwcslyN</code> will set to the target executable path <code>[%LOCALAPPDATA]\FRKBrMZCk\LDeviceDetectionHelper.exe</code></li>
</ul>
<h3 id="installexecutesequence-table">InstallExecuteSequence Table</h3>
<p>Custom Actions cannot be triggered on its own, thus there must be some scheduling that dictates when to launch, there comes the <a href="https://learn.microsoft.com/en-us/windows/win32/msi/installexecutesequence-table">InstallExecuteSequence</a> table that defines actions to be executed in sequence.
<img src="/mat-redDelta-plugx/msi-installExecuteSeq-table.png" alt="msi-installExecuteSeq-table"></p>
<p>Above screenshot shows the <code>InstallExecuteSequence</code> table for this MSI file, where important actions goes like this:</p>
<ul>
<li><code>SetOblsaYFUJOqn (Sequence 801)</code> : set a property (<code>OblsaYFUJOqn</code>) to <code>[%LOCALAPPDATA]\FRKBrMZCk</code> likely used by subsequent custom actions,</li>
<li>then <a href="https://learn.microsoft.com/en-us/windows/win32/msi/installinitialize-action">InstallInitialize</a> action and <a href="https://learn.microsoft.com/en-us/windows/win32/msi/installfinalize-action">InstallFinalize</a> action mark the beginning and end of a sequence of actions that commits the system changes.</li>
<li>in the end, <code>WwcslyN (Sequence 6601)</code> : means it will execute after successful commit on system changes made during installation process, where condition <code>NOT REMOVE</code> indicates not to run it during uninstallation.</li>
</ul>
<p><strong>In short</strong>, This MSI file drops the three files into the user&rsquo;s <code>LocalAppData\FRKBrMZCk</code>folder,
<img src="/mat-redDelta-plugx/msi-files-dropped-in-explorer.png" alt="msi-files-dropped-in-explorer"></p>
<p>and launches an executable <code>LDeviceDetectionHelper.exe</code> after the installation has finalized.
<img src="/mat-redDelta-plugx/legtimate-file-proc-create-procmon-event.png" alt="legtimate-file-proc-create-procmon-event"></p>
<hr>
<h1 id="a-betrayal-to-tell--legitimate-executable">A betrayal to tell : legitimate executable</h1>
<p>Now that we know <code>LDeviceDetectionHelper.exe</code> is decent file,
and gonna load <code>hid.dll</code> module because its vulnerable to <a href="https://unit42.paloaltonetworks.com/dll-hijacking-techniques/">DLL Hijacking Techniques</a>, <a href="https://attack.mitre.org/techniques/T1574/002/">DLL Side Loading (T1574.002)</a> to be specific,</p>
<blockquote>
<p>this tactic has also been noticed in other operations of RedDelta (see footnotes <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> <sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> <sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>).</p></blockquote>
<p>And the <code>Procmon</code> captured events reflects the same:
<img src="/mat-redDelta-plugx/legitimate-file-dll-hijacking-procmon-event.png" alt="legitimate-file-dll-hijacking-procmon-event"></p>
<p>Now the actual point where the trigger happens goes like this:
the innocent <code>LDeviceDetectionHelper.exe</code> usually calls an export from <code>hid.dll</code> ie. <code>HidD_GetHidGuid</code> at offset <code>LDeviceDetectionHelper.exe+0x6DBD2</code> within <code>sub_46E7A0</code> subroutine, as we can see below
<img src="/mat-redDelta-plugx/legitimate-file-subroutine-loads-hid-dll.png" alt="legitimate-file-subroutine-loads-hid-dll"></p>
<p>Usually the executable would have loaded the normal <code>C:/Windows/SysWOW64/hid.dll</code>, but the fact it&rsquo;s vulnerable to DLL search order hijacking and does not verify the loaded module, this loads and executes the malicious <code>hid.dll</code>&rsquo;s export <code>HidD_GetHidGuid</code> instead.</p>
<p>You can see the comparison between the two <code>hid.dll</code>:
<img src="/mat-redDelta-plugx/hid-dll-s-comparision.png" alt="hid-dll-s-comparision"></p>
<hr>
<h1 id="the-disguise--nim-loader">The disguise : NIM Loader</h1>
<p>The <code>hid.dll</code> is written using NIM language, looking at dll exports we see the disguised export <code>HidD_GetHidGuid</code>, let&rsquo;s see what this function does
<img src="/mat-redDelta-plugx/hid-dll-exports.png" alt="hid-dll-exports"></p>
<blockquote>
<p><strong>TIP</strong>: NIM is notorious when comes to shipping symbols which makes it hard to identify even system calls. So one can use tools like <a href="https://github.com/eset/nimfilt">NimFilt</a> to demangle NIM symbols with your desired disassembler</p></blockquote>
<h2 id="hidd_gethidguid-subroutine">HidD_GetHidGuid subroutine</h2>
<ul>
<li>this starts by dynamically resolving Windows API&rsquo;s functions with a call to a subroutine <code>sub_6E848AAC</code> that uses series of functions referenced from <a href="https://github.com/S3cur3Th1sSh1t/Nim_DInvoke">Nim_DInvoke Library</a>,</li>
<li>like <code>DInvoke::get_library_address</code> along with <code>DInvoke::get_function_address</code> supplied with hash to dynamically resolve windows functions</li>
<li>and has a custom api hashing routine <code>sub_6E847344</code> (ie. <code>@getHash__687nvoke_u95@4</code> at offset <code>hid.dll+0x6944</code>) and <a href="#api-name-resolve-script">here&rsquo;s</a> a quick python script for de-hashing them</li>
<li>having function names resolved, we see it calls <a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-registerclassw">RegisterClassW</a> to register <a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/ns-winuser-wndclassa">WNDCLASS STRUCT</a> which has an interesting member <code>WNDPROC lpfnWndProc</code>, looking on MSDN it says:</li>
</ul>
<blockquote>
<p><strong>WNDPROC callback function</strong> :
A callback function, which you define in your application, that processes messages sent to a window. The <strong>WNDPROC</strong> type defines a pointer to this callback function.</p></blockquote>
<ul>
<li>and the callback function is set to <code>sub_6E847C4C</code> (ie. <code>_mgdtfX__8788p_u880@16</code> at offset <code>hid.dll+0x724C</code>) which is triggered with subsequent calls related window manipulation like <a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-createwindowexw">CreateWindowExW</a> , <a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-showwindow">ShowWindow</a> (see <a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-createwindowexw#remarks">Remarks</a> for why).</li>
</ul>
<p><img src="/mat-redDelta-plugx/hid-dll-creates-hidden-window-class.png" alt="hid-dll-creates-hidden-window-class"></p>
<ul>
<li>and creates a hidden Window Class name <code>EDIT</code>. Which is an identifiable attributes for PlugX . This behavior is mentioned in this <a href="https://unit42.paloaltonetworks.com/thor-plugx-variant/">Unit42 THOR PlugX Variant article</a></li>
</ul>
<h2 id="_mgdtfx__8788p_u88016-subroutine">_mgdtfX__8788p_u880@16 subroutine</h2>
<p>This will make a call to <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread">CreateThread</a> where argument <code>lpStartAddress</code> points to function <code>sub_6E8488B8</code> (ie. <code>_bxRoBaPhPJT__8788p_u824@4</code> at offset <code>hid.dll+0x7EB8</code>) which is executed immediately as <code>dwCreationFlags</code> is <code>0</code></p>
<h2 id="_bxrobaphpjt__8788p_u8244-subroutine">_bxRoBaPhPJT__8788p_u824@4 subroutine</h2>
<ul>
<li>grabs the path to <code>LDevice.dat</code> then make a call to <code>sub_6E848545</code> (ie. <code>@CtOtHXjnm__8788p_u277@12</code> at offset <code>0x7B45</code>) that will first RC4 decrypt <code>LDevice.dat</code> with harcoded key <code>BhaPKNSALeXZBJYz</code></li>
</ul>
<blockquote>
<p><strong>TIP</strong>: bunch of <code>256</code> constants in a subroutine is usually an indicator of RC4 algorithm used</p></blockquote>
<p><img src="/mat-redDelta-plugx/decrypted-dat-file-injected-in-legitimate-exe.png" alt="decrypted-dat-file-injected-in-legitimate-exe"></p>
<ul>
<li>decrypted <code>LDevice.dat</code> is then injected to same legitimate process of <code>LDeviceDetectionHelper.exe</code> using sequence of system windows API calls like <code>ZwAllocateVirtualMemory</code>, <code>NtWriteVirtualMemory</code>, <code>NtProtectVirtualMemory</code>, and <a href="https://learn.microsoft.com/en-us/windows/win32/api/winnls/nf-winnls-enumsystemgeoid">EnumSystemGeoID</a> where callback function <code>lpGeoEnumProc</code> points to this decrypted executable memory region.</li>
</ul>
<p>Resulting in deploying PlugX RAT, VT detection clearly associates this file with family label <code>korpug</code>, <code>plugx</code>, <code>zusy</code>
<img src="/mat-redDelta-plugx/vt-detection-plugx-rat.png" alt="vt-detection-plugx-rat"></p>
<hr>
<h1 id="decoy-document">Decoy document</h1>
<p>It also presents user with <code>Meeting Invitation.pdf</code> loaded in the user’s PDF viewer describing a Zoom meeting invite.
<img src="/mat-redDelta-plugx/decoy-document.png" alt="decoy-document"></p>
<hr>
<h1 id="persistence">Persistence</h1>
<p><img src="/mat-redDelta-plugx/persistence-using-auto-run.png" alt="persistence-using-auto-run">After copying executable and malicious module to new location,a new run registry key value <code>SetPoint</code> is created for persistence, which executes <code>LDeviceDetectionHelper.exe</code> upon user login.</p>
<hr>
<h1 id="conclusion">Conclusion</h1>
<p>RedDelta Group uses customized PlugX malware to carry out its espionage with evolving Tactics, Techniques &amp; procedures(TTPs) like abusing Legitimate and digitally signed binaries, using sophisticated MSI files to bundle all the required files, also adapting to new programming languages like NIM. Hinting RedDelta will continue its campaign with evolved infection chains.</p>
<p>Also steps taken by authorities in response of Chinese APTs and PlugX like
<a href="https://www.justice.gov/archives/opa/pr/justice-department-and-fbi-conduct-international-operation-delete-malware-used-china-backed">Justice Department and FBI Conduct International Operation to Delete Malware Used by China-Backed Hackers</a></p>
<hr>
<h1 id="automation-script">Automation script</h1>
<h2 id="api-name-resolve-script">api name resolve script</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pefile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">custom_hash</span>(input_str):
</span></span><span style="display:flex;"><span>    hash_value <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xC0DE1337</span>
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        chr_value <span style="color:#f92672">=</span> ord(input_str[i]) <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> len(input_str) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> chr_value:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        hash_value <span style="color:#f92672">^=</span> chr_value <span style="color:#f92672">+</span> ((hash_value <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> (hash_value <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> hex(hash_value <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFFFFFFFFFF</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">api_hash_resolve</span>(dllToLoad, hashToResolve):
</span></span><span style="display:flex;"><span>    pe <span style="color:#f92672">=</span> pefile<span style="color:#f92672">.</span>PE(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;C:\Windows\SysWOW64\</span><span style="color:#e6db74">{</span>dllToLoad<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> exp <span style="color:#f92672">in</span> pe<span style="color:#f92672">.</span>DIRECTORY_ENTRY_EXPORT<span style="color:#f92672">.</span>symbols:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> exp<span style="color:#f92672">.</span>name <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> custom_hash(exp<span style="color:#f92672">.</span>name<span style="color:#f92672">.</span>decode()) <span style="color:#f92672">==</span> hex(int(hashToResolve, <span style="color:#ae81ff">16</span>)):
</span></span><span style="display:flex;"><span>                print(exp<span style="color:#f92672">.</span>name<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    dllList <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;kernel32.dll&#34;</span>, <span style="color:#e6db74">&#34;ntdll.dll&#34;</span>, <span style="color:#e6db74">&#34;user32.dll&#34;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;DLLs Available: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">0: </span><span style="color:#e6db74">{</span>dllList[<span style="color:#ae81ff">0</span>]<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">1: </span><span style="color:#e6db74">{</span>dllList[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">2: </span><span style="color:#e6db74">{</span>dllList[<span style="color:#ae81ff">2</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    dllNumber <span style="color:#f92672">=</span> int(input(<span style="color:#e6db74">&#34;Choose DLL number: &#34;</span>))
</span></span><span style="display:flex;"><span>    hashToResolve <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Hash(hex) to Resolve: &#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    api_hash_resolve(dllList[dllNumber], hashToResolve)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;__main__&#34;</span> <span style="color:#f92672">==</span> __name__:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><hr>
<h1 id="indicatior-of-compromises-iocs">Indicatior of Compromises (IOCs)</h1>
<table>
  <thead>
      <tr>
          <th>FILE NAME</th>
          <th>SHA256</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>Meeting invitaion.msc</code></td>
          <td><code>ca0dfda9a329f5729b3ca07c6578b3b6560e7cfaeff8d988d1fe8c9ca6896da5</code></td>
      </tr>
      <tr>
          <td><code>ver.dat</code> MSI file</td>
          <td><code>2d884fd8cfa585adec7407059064672d06a6f4bdc28cf4893c01262ef15ddb99</code></td>
      </tr>
      <tr>
          <td><code>LDeviceDetectionHelper.exe</code></td>
          <td><code>282fc12e4f36b6e2558f5dd33320385f41e72d3a90d0d3777a31ef1ba40722d6</code></td>
      </tr>
      <tr>
          <td><code>hid.dll</code> the NIM loader</td>
          <td><code>1a37289c70c78697b85937ae4e1e8a4cebb7972c731aceaef2813e241217f009</code></td>
      </tr>
      <tr>
          <td><code>LDevice.dat</code></td>
          <td><code>37c7bdac64e279dc421de8f8a364db1e9fd1dcca3a6c1d33df890c1da7573e9f</code></td>
      </tr>
      <tr>
          <td>domain used to downlaod MSI file</td>
          <td><code>hxxps[:]//cdn7s65[.]z13[.]web[.]core[.]windows[.]net</code></td>
      </tr>
      <tr>
          <td>decrypted <code>LDevice.dat</code> ie. PlugX malware</td>
          <td><code>d7a4255297c91d26d726dec228379278b393486e6fa8a57b9b7a5176ca52f91e</code></td>
      </tr>
      <tr>
          <td><code>Meeting Invitation.pdf</code></td>
          <td><code>9d844b275725e6241f6e70d17ed68bb7eb90b684832ef5952a91a5040ffe5d94</code></td>
      </tr>
      <tr>
          <td>connection made</td>
          <td><code>hxxps[:]//conflictaslesson[.]com[:]443</code></td>
      </tr>
  </tbody>
</table>
<hr>
<h1 id="mitre-attck-techniques">MITRE ATT&amp;CK Techniques</h1>
<table>
  <thead>
      <tr>
          <th>TACTIC: TECHNIQUE</th>
          <th>ATT&amp;CK CODE</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Initial Access</strong>: Phishing - Spearphishing Attachment</td>
          <td><a href="https://attack.mitre.org/techniques/T1566/001/">T1566.001</a></td>
      </tr>
      <tr>
          <td><strong>Initial Access</strong>: Phishing - Spearphishing Link</td>
          <td><a href="https://attack.mitre.org/techniques/T1566/002/">T1566.002</a></td>
      </tr>
      <tr>
          <td><strong>Execution</strong>: User Execution - Malicious File</td>
          <td><a href="https://attack.mitre.org/techniques/T1204/002/">T1204.002</a></td>
      </tr>
      <tr>
          <td><strong>Execution</strong>: Command and Scripting Interpreter: Visual Basic</td>
          <td><a href="https://attack.mitre.org/techniques/T1059/005/">T1059.005</a></td>
      </tr>
      <tr>
          <td><strong>Persistence</strong>: Boot or Logon Autostart Execution — Registry Run Keys</td>
          <td><a href="https://attack.mitre.org/techniques/T1547/001/">T1547.001</a></td>
      </tr>
      <tr>
          <td><strong>Defense Evasion</strong>: Hijack Execution Flow -  DLL Search Order Hijacking</td>
          <td><a href="https://attack.mitre.org/techniques/T1574/001/">T1574.001</a></td>
      </tr>
      <tr>
          <td><strong>Defense Evasion</strong>: Hijack Execution Flow - DLL Side-Loading</td>
          <td><a href="https://attack.mitre.org/techniques/T1574/002/">T1574.002</a></td>
      </tr>
      <tr>
          <td><strong>Defense Evasion</strong>: Deobfuscate/Decode Files or Information</td>
          <td><a href="https://attack.mitre.org/techniques/T1140/">T1140</a></td>
      </tr>
      <tr>
          <td><strong>Defense Evasion</strong>: System Binary Proxy Execution: MMC</td>
          <td><a href="https://attack.mitre.org/techniques/T1218/014/">T1218.014</a></td>
      </tr>
      <tr>
          <td><strong>Defense Evasion</strong>: System Binary Proxy Execution: Msiexec</td>
          <td><a href="https://attack.mitre.org/techniques/T1218/007/">T1218.007</a></td>
      </tr>
      <tr>
          <td><strong>Defense Evasion</strong>: Masquerading: Match Legitimate Name or Location</td>
          <td><a href="https://attack.mitre.org/techniques/T1036/005/">T1036.005</a></td>
      </tr>
      <tr>
          <td><strong>Defense Evasion</strong>: Masquerading: Double File Extension</td>
          <td><a href="https://attack.mitre.org/techniques/T1036/007/">T1036.007</a></td>
      </tr>
  </tbody>
</table>
<hr>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://intezer.com/blog/incident-response/how-to-analyze-malicious-msi-installer-files/">How to Analyze Malicious MSI Installer Files</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://mgeeky.tech/msi-shenanigans-part-1/">MSI Shenanigans. Part 1 - Offensive Capabilities Overview</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://unit42.paloaltonetworks.com/stately-taurus-abuses-vscode-southeast-asian-espionage/">Chinese APT Abuses VSCode to Target Government in Asia</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://www.cybereason.com/blog/threat-analysis-report-plugx-rat-loader-evolution">THREAT ANALYSIS REPORT: PlugX RAT Loader Evolution</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p><a href="https://www.splunk.com/en_us/blog/security/unmasking-the-enigma-a-historical-dive-into-the-world-of-plugx-malware.html">Unmasking the Enigma: A Historical Dive into the World of PlugX Malware</a>&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
</section>

  
  
  <footer class="mt-12 flex flex-wrap">
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://theabsnt.github.io/tags/reverse-engineering"
      >reverse engineering</a
    >
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://theabsnt.github.io/tags/reddelta"
      >reddelta</a
    >
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://theabsnt.github.io/tags/malware-analysis"
      >malware analysis</a
    >
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://theabsnt.github.io/tags/plugx"
      >plugx</a
    >
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://theabsnt.github.io/tags/malware-campaign"
      >malware campaign</a
    >
    
  </footer>
  

  
  
  
  
  <nav
    class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg !leading-[1.2] *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"
  >
    
    
    <a class="ltr:ml-auto rtl:mr-auto justify-end pl-3" href="https://theabsnt.github.io/posts/z2a_chall/ch01_gozi_string_decryption/"
      ><span>Challenge #1: Gozi String Decryption</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a
    >
    
  </nav>
  
  

  
  

  
  

  


  
</article>


    </main>

    <footer
  class="mx-auto flex h-[4.5rem] max-w-[--w] items-center px-8 text-xs uppercase tracking-wider opacity-60"
>
  <div class="mr-auto">
  
    &copy; 2025
    <a class="link" href="https://theabsnt.github.io/">TheAbsnt</a>
  
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >powered by hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >hugo-paper</a
  >
</footer>

  </body>
</html>
